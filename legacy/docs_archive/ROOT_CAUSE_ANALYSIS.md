# Connection Timeout ê·¼ë³¸ ì›ì¸ ë¶„ì„ ë° í•´ê²° ë°©ì•ˆ

**ì‘ì„±ì¼**: 2025-10-13  
**ë¶„ì„ ëŒ€ìƒ**: a.log (90ê±´ì˜ "connection already closed" ì—ëŸ¬)

---

## ğŸ“Š ì—ëŸ¬ íŒ¨í„´ ë¶„ì„

### ì‹¤í–‰ ì‹œê°„ í†µê³„
- **ìµœì†Œ**: 950.27ì´ˆ (15.8ë¶„)
- **ìµœëŒ€**: 8159.23ì´ˆ (2.27ì‹œê°„)
- **í‰ê· **: 7963.72ì´ˆ (2.21ì‹œê°„)
- **ì¤‘ê°„ê°’**: 8122.89ì´ˆ

### ì‹œê°„ëŒ€ë³„ ë¶„í¬
- 2ì‹œê°„(7200ì´ˆ) ì´ìƒ: **89ê±´ (98.9%)**
- 2.2ì‹œê°„(7900ì´ˆ) ì´ìƒ: **88ê±´ (97.8%)**
- ì •í™•íˆ 8126.46ì´ˆ: **42ê±´ (46.7%)** âš ï¸

### ì—ëŸ¬ ë©”ì‹œì§€
```
Query failed after 8126.46 seconds: connection already closed
Failed to migrate chunk [start_time] to [end_time]: connection already closed
```

---

## ğŸ¯ ê·¼ë³¸ ì›ì¸ (Root Cause)

### 1. PostgreSQL ì„œë²„ ì¸¡ íƒ€ì„ì•„ì›ƒ â­â­â­â­â­
**ì¦ê±°**:
- 42ê±´(46.7%)ì´ ì •í™•íˆ **8126.46ì´ˆ**(2ì‹œê°„ 15ë¶„ 26ì´ˆ)ì—ì„œ ì‹¤íŒ¨
- ì´ëŠ” ì„œë²„ì— ì„¤ì •ëœ íŠ¹ì • íƒ€ì„ì•„ì›ƒì˜ ëª…ë°±í•œ ì¦ê±°

**ê°€ëŠ¥í•œ íƒ€ì„ì•„ì›ƒ ì„¤ì •**:
- `statement_timeout`: ë‹¨ì¼ SQL ë¬¸ ì‹¤í–‰ ì œí•œ ì‹œê°„
- `idle_in_transaction_session_timeout`: íŠ¸ëœì­ì…˜ ìœ íœ´ ì‹œê°„ ì œí•œ
- `tcp_keepalives_idle/interval/count`: TCP ì—°ê²° ìœ ì§€ ì„¤ì •

### 2. ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì‹œê°„ â­â­â­â­
**í˜„ì¬ ìƒí™©**:
- `chunk_size_hours`: 6ì‹œê°„ â†’ í‰ê·  2.21ì‹œê°„ ì†Œìš”
- narrow í…Œì´ë¸”ì—ì„œ ëŒ€ëŸ‰ì˜ ë°ì´í„°ë¥¼ ì½ê³  ë³€í™˜í•˜ëŠ” ê³¼ì •ì´ ë§¤ìš° ëŠë¦¼
- `ORDER BY created_time`ìœ¼ë¡œ ì¸í•œ ì¶”ê°€ ì„±ëŠ¥ ì €í•˜
- 93ê°œ `data_channel_id`ì— ëŒ€í•œ IN ì ˆ ì²˜ë¦¬

### 3. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìœ ì§€ ë¬¸ì œ â­â­â­
**í˜„ì¬ ì½”ë“œ**:
- psycopg2 ì—°ê²° ì‹œ keepalive ì„¤ì • ì—†ìŒ
- ì¥ì‹œê°„ ì¿¼ë¦¬ ì‹¤í–‰ ì¤‘ TCP ì—°ê²°ì´ ëŠì–´ì§ˆ ìˆ˜ ìˆìŒ
- ë¡œë“œ ë°¸ëŸ°ì„œë‚˜ ë°©í™”ë²½ì˜ idle timeout
- Azure PostgreSQLì˜ ê¸°ë³¸ ì—°ê²° ì œí•œ

---

## ğŸ’¡ í•´ê²° ë°©ì•ˆ

### ë°©ì•ˆ 1: ì²­í¬ í¬ê¸° ì¶•ì†Œ â­â­â­â­â­
**ê°€ì¥ íš¨ê³¼ì ì´ê³  ì¦‰ì‹œ ì ìš© ê°€ëŠ¥**

**í˜„ì¬ ìƒí™©**:
```python
# config.py
chunk_size_hours: int = 6  # 6ì‹œê°„ â†’ í‰ê·  2.21ì‹œê°„ ì†Œìš” â†’ íƒ€ì„ì•„ì›ƒ
```

**í•´ê²°ì±…**:
```python
# config.py
chunk_size_hours: int = 2  # 6ì‹œê°„ â†’ 2ì‹œê°„ìœ¼ë¡œ ì¶•ì†Œ
# ë˜ëŠ”
chunk_size_hours: int = 1  # ë” ì•ˆì „í•˜ê²Œ 1ì‹œê°„
```

**ì¥ì **:
- âœ… ê°€ì¥ ì•ˆì „í•˜ê³  í™•ì‹¤í•œ ë°©ë²•
- âœ… ì½”ë“œ ìˆ˜ì •ì´ ê°„ë‹¨ (config.py í•œ ì¤„)
- âœ… íƒ€ì„ì•„ì›ƒ ë°œìƒ ì „ì— ì™„ë£Œ
- âœ… ì‹¤íŒ¨ ì‹œ ì¬ì²˜ë¦¬ ë²”ìœ„ ì¶•ì†Œ (ë³µêµ¬ ë¹ ë¦„)
- âœ… ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ë„ ê°ì†Œ

**ë‹¨ì **:
- âš ï¸ ì „ì²´ ì²˜ë¦¬ ì‹œê°„ì´ ì•½ê°„ ì¦ê°€í•  ìˆ˜ ìˆìŒ (ì˜¤ë²„í—¤ë“œ)
- âš ï¸ ë” ë§ì€ ì²­í¬ ì²˜ë¦¬ í•„ìš”

**ì˜ˆìƒ íš¨ê³¼**:
- ì²­í¬ë‹¹ ì²˜ë¦¬ ì‹œê°„: 2.21ì‹œê°„ â†’ 40~50ë¶„ ì´ë‚´
- íƒ€ì„ì•„ì›ƒ ì—¬ìœ : 1.5ì‹œê°„ ì´ìƒ

---

### ë°©ì•ˆ 2: Connection Keepalive ì„¤ì • â­â­â­â­

**í˜„ì¬ ìƒí™©**:
```python
# config.py
@property
def connection_string(self) -> str:
    return f"postgresql://{self.user}:{self.password}@{self.host}:{self.port}/{self.database}"
```

**í•´ê²°ì±…**:
```python
# config.py
@property
def connection_string(self) -> str:
    return (
        f"postgresql://{self.user}:{self.password}@{self.host}:{self.port}/{self.database}"
        f"?keepalives=1"
        f"&keepalives_idle=30"      # 30ì´ˆë§ˆë‹¤ keepalive í™•ì¸
        f"&keepalives_interval=10"   # 10ì´ˆ ê°„ê²©ìœ¼ë¡œ ì¬ì‹œë„
        f"&keepalives_count=5"       # 5ë²ˆ ì‹¤íŒ¨ ì‹œ ì—°ê²° ëŠê¹€
    )
```

**ì¥ì **:
- âœ… ì¥ì‹œê°„ ì¿¼ë¦¬ì—ì„œë„ ì—°ê²° ìœ ì§€
- âœ… ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ì¡°ê¸° ê°ì§€
- âœ… Azure PostgreSQLê³¼ í˜¸í™˜

**ë‹¨ì **:
- âš ï¸ ê·¼ë³¸ ì›ì¸(ì¿¼ë¦¬ ì‹œê°„)ì„ í•´ê²°í•˜ì§€ëŠ” ì•ŠìŒ
- âš ï¸ Azure PostgreSQLì—ì„œ íš¨ê³¼ê°€ ì œí•œì ì¼ ìˆ˜ ìˆìŒ

---

### ë°©ì•ˆ 3: ì„œë²„ ì¸¡ íƒ€ì„ì•„ì›ƒ ì¦ê°€ â­â­â­
**DBA í˜‘ì—… í•„ìš”**

**í˜„ì¬ ì„¤ì • í™•ì¸**:
```sql
-- PostgreSQLì—ì„œ ì‹¤í–‰
SHOW statement_timeout;
SHOW idle_in_transaction_session_timeout;
```

**íƒ€ì„ì•„ì›ƒ ì¦ê°€**:
```sql
-- ì„¸ì…˜ë³„ ì„¤ì • (ì¬ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸ì— ì¶”ê°€)
SET statement_timeout = '4h';
SET idle_in_transaction_session_timeout = '4h';

-- ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì „ì²´ ì„¤ì • (DBA ê¶Œí•œ í•„ìš”)
ALTER DATABASE tenant_builder SET statement_timeout = '4h';
```

**ì¥ì **:
- âœ… ì¥ì‹œê°„ ì¿¼ë¦¬ ì‹¤í–‰ ê°€ëŠ¥

**ë‹¨ì **:
- âš ï¸ DBA ê¶Œí•œ í•„ìš”
- âš ï¸ ë‹¤ë¥¸ ì¿¼ë¦¬ì—ë„ ì˜í–¥ (ì „ì—­ ì„¤ì • ì‹œ)
- âš ï¸ Azure PostgreSQLì€ ì œí•œì ì¼ ìˆ˜ ìˆìŒ
- âš ï¸ ê·¼ë³¸ ë¬¸ì œ(ì¿¼ë¦¬ ì„±ëŠ¥) ë¯¸í•´ê²°

---

### ë°©ì•ˆ 4: ì¿¼ë¦¬ ìµœì í™” â­â­â­

**ì¸ë±ìŠ¤ ìµœì í™”**:
```sql
-- ë§ˆì´ê·¸ë ˆì´ì…˜ ì¿¼ë¦¬ì— ìµœì í™”ëœ ì¸ë±ìŠ¤
CREATE INDEX IF NOT EXISTS idx_timeseries_migration 
ON tenant.tbl_data_timeseries(ship_id, created_time, data_channel_id);
```

**ì¿¼ë¦¬ ê°œì„ **:
- ORDER BY ì œê±° (í•„ìš”í•œ ê²½ìš°ë§Œ ì‚¬ìš©)
- LIMIT ì¶”ê°€ë¡œ ë©”ëª¨ë¦¬ ì œì–´
- ë³‘ë ¬ ì¿¼ë¦¬ í™œìš©

**ì¥ì **:
- âœ… ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ ë‹¨ì¶•
- âœ… ê·¼ë³¸ì ì¸ ì„±ëŠ¥ ê°œì„ 

**ë‹¨ì **:
- âš ï¸ ì¸ë±ìŠ¤ ìƒì„± ì‹œê°„ ì†Œìš”
- âš ï¸ ì¸ë±ìŠ¤ë¡œ ì¸í•œ INSERT ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥
- âš ï¸ íš¨ê³¼ê°€ ì œí•œì ì¼ ìˆ˜ ìˆìŒ

---

### ë°©ì•ˆ 5: ì¬ì‹œë„ ë¡œì§ ê°•í™” â­â­

**ìë™ ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜**:
- Exponential backoff
- íƒ€ì„ì•„ì›ƒ ë°œìƒ ì‹œ ì²­í¬ ë¶„í• 
- ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬

**ì¥ì **:
- âœ… ì¼ì‹œì  ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ëŒ€ì‘
- âœ… ìë™ ë³µêµ¬

**ë‹¨ì **:
- âš ï¸ ë³µì¡ë„ ì¦ê°€
- âš ï¸ ê·¼ë³¸ ì›ì¸ ë¯¸í•´ê²°

---

## ğŸ¯ ê¶Œì¥ í•´ê²° ë°©ì•ˆ

### ìµœìš°ì„  (ì¦‰ì‹œ ì ìš©): ë°©ì•ˆ 1 + ë°©ì•ˆ 2

#### 1ë‹¨ê³„: chunk_size_hours ì¶•ì†Œ
```python
# config.py
chunk_size_hours: int = 2  # 6 â†’ 2ë¡œ ì¶•ì†Œ
```

#### 2ë‹¨ê³„: Connection Keepalive ì¶”ê°€
```python
# config.py
@property
def connection_string(self) -> str:
    return (
        f"postgresql://{self.user}:{self.password}@{self.host}:{self.port}/{self.database}"
        f"?keepalives=1"
        f"&keepalives_idle=30"
        f"&keepalives_interval=10"
        f"&keepalives_count=5"
    )
```

#### ì˜ˆìƒ íš¨ê³¼:
- âœ… ì²­í¬ë‹¹ ì²˜ë¦¬ ì‹œê°„: 2ì‹œê°„ â†’ 40ë¶„ ì´ë‚´
- âœ… íƒ€ì„ì•„ì›ƒ ë°œìƒ ì „ì— ì™„ë£Œ
- âœ… ì—°ê²° ì•ˆì •ì„± í–¥ìƒ
- âœ… 90ê±´ì˜ ì‹¤íŒ¨ ëŒ€ë¶€ë¶„ í•´ê²°

---

## ğŸ“‹ ì‹¤í–‰ ê³„íš

### 1. ì¦‰ì‹œ ì¡°ì¹˜ (ì½”ë“œ ìˆ˜ì • ì—†ì´ í…ŒìŠ¤íŠ¸)
- [ ] DBAì—ê²Œ ìš”ì²­:
  - `SHOW statement_timeout;` ì‹¤í–‰
  - `SHOW idle_in_transaction_session_timeout;` ì‹¤í–‰
  - í˜„ì¬ ì„¤ì •ê°’ í™•ì¸

- [ ] ì„ì‹œ ì¬ì²˜ë¦¬ í…ŒìŠ¤íŠ¸:
  - post_proc.csvë¥¼ 2~3ê°œ ì²­í¬ë¡œ ë¶„í• 
  - ì‘ì€ ê·œëª¨ë¡œ ë¨¼ì € í…ŒìŠ¤íŠ¸

### 2. ë‹¨ê¸° ì¡°ì¹˜ (1-2ì¼)
- [ ] `config.py` ìˆ˜ì •:
  - `chunk_size_hours: 6 â†’ 2`
  - connection_stringì— keepalives ì¶”ê°€

- [ ] í…ŒìŠ¤íŠ¸ ì‹¤í–‰:
  - 1ê°œ ì„ ë°•ìœ¼ë¡œ ê²€ì¦
  - ë¡œê·¸ í™•ì¸

- [ ] ì „ì²´ ì¬ì²˜ë¦¬:
  - `./reprocess_failed_chunks.sh`

### 3. ì¤‘ì¥ê¸° ì¡°ì¹˜ (1-2ì£¼)
- [ ] ì¿¼ë¦¬ ì„±ëŠ¥ ë¶„ì„
- [ ] ì¸ë±ìŠ¤ ìµœì í™”
- [ ] ìë™ ì¬ì‹œë„ ë¡œì§ ì¶”ê°€

---

## ğŸ“Š ì˜ˆìƒ íš¨ê³¼

### í˜„ì¬ (chunk_size_hours: 6)
- ì²­í¬ë‹¹ ì²˜ë¦¬ ì‹œê°„: í‰ê·  2.21ì‹œê°„
- íƒ€ì„ì•„ì›ƒ ë°œìƒ: 8126ì´ˆ (2.26ì‹œê°„)
- ì‹¤íŒ¨ìœ¨: ë§¤ìš° ë†’ìŒ (90ê±´ ì „ë¶€ ì‹¤íŒ¨)
- ì¬ì²˜ë¦¬ ë²”ìœ„: 6ì‹œê°„ì¹˜ ë°ì´í„°

### ë°©ì•ˆ ì ìš© í›„ (chunk_size_hours: 2)
- ì²­í¬ë‹¹ ì²˜ë¦¬ ì‹œê°„: ì˜ˆìƒ 40~50ë¶„
- íƒ€ì„ì•„ì›ƒ ì—¬ìœ : ì¶©ë¶„ (1.5ì‹œê°„ ì—¬ìœ )
- ì‹¤íŒ¨ìœ¨: ëŒ€í­ ê°ì†Œ ì˜ˆìƒ
- ì¬ì²˜ë¦¬ ë²”ìœ„: 2ì‹œê°„ì¹˜ë¡œ ì¶•ì†Œ

---

## âœ¨ ê²°ë¡ 

**ê°€ì¥ íš¨ê³¼ì ì´ê³  ë¹ ë¥¸ í•´ê²°ì±…**:

1. `chunk_size_hours`ë¥¼ 6 â†’ 2ë¡œ ì¶•ì†Œ (config.py í•œ ì¤„ ìˆ˜ì •)
2. Connection keepalives ì¶”ê°€ (config.py connection_string ìˆ˜ì •)
3. í…ŒìŠ¤íŠ¸ í›„ ì „ì²´ ì¬ì²˜ë¦¬

ì´ ì¡°í•©ìœ¼ë¡œ **90ê±´ì˜ ì‹¤íŒ¨ë¥¼ ëŒ€ë¶€ë¶„ í•´ê²°**í•  ìˆ˜ ìˆì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [PostgreSQL Statement Timeout](https://www.postgresql.org/docs/current/runtime-config-client.html#GUC-STATEMENT-TIMEOUT)
- [psycopg2 Connection Parameters](https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-KEEPALIVES)
- [Azure PostgreSQL Timeouts](https://learn.microsoft.com/en-us/azure/postgresql/)

